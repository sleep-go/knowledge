# 改进知识库与用户体验 Spec

## 目标
用户希望改进会话标题生成（更干净）、自动创建会话流程（更流畅）、知识库智能度（更好的上下文），并支持直接上传和解析文件。

## 变更内容
- **严格的标题净化**：从生成的标题中移除特殊字符。
- **自动创建会话**：如果用户在没有选中会话时发送消息，自动创建一个新会话。
- **更聪明的知识库**：
  - 增加检索的上下文窗口大小和分片数量。
  - 实现重叠分片，以保留边界上下文。
- **文件上传**：
  - 添加上传文件到知识库的 API。
  - 添加选择并上传文件的 UI。

## 影响
- **受影响的 Spec**: `document-startup`, `fix-kb-path-and-retrieval` (与 KB 相关)。
- **受影响的代码**:
  - `internal/server/utils.go` (标题, KB 上下文)
  - `web/static/script.js` (自动创建, 上传 UI)
  - `internal/kb/knowledge_base.go` (分片, 文件处理)
  - `internal/server/router.go` & `handler_kb.go` (上传 API)

## 新增需求

### 需求：严格的标题净化
系统应确保生成的标题不包含特殊字符或标点符号。
- **当** 生成或净化标题时
- **则** 它应该只包含字母数字字符（包括汉字）、空格或简单的分隔符（连字符/下划线）。应移除如 `*`, `#`, `[`, `]`, `。`, `，` 等标点。

### 需求：自动创建会话
如果用户在没有选中会话时发送消息，系统应自动创建一个新会话。
- **当** 用户输入消息并点击发送（或按 Enter）
- **且** `currentConversationId` 为空
- **则** 系统创建一个名为“新会话”（或类似默认值）的新会话
- **并** 立即将用户的消息发送到这个新会话。

### 需求：改进的 KB 检索
系统应从知识库提供更相关的上下文。
- **分片**：分片应有重叠（例如 100 字符），以防止边界处的上下文丢失。
- **检索**：系统应检索更多分片（例如前 5 个）并允许更大的上下文窗口（例如 3000 字符）给 LLM。

### 需求：文件上传
系统应允许用户通过 UI 上传文件到知识库。
- **API**：`POST /api/kb/upload` 接受 `multipart/form-data`。
- **UI**：在知识库设置区域添加“上传文件”按钮。
- **处理**：上传的文件保存到 KB 文件夹并立即处理（解析和索引）。

## 修改的需求
### 需求：KB 分片策略
**修改**：从固定的 300 字符无重叠分片改为更大的（例如 500 字符）带重叠的分片。

### 需求：KB 上下文注入
**修改**：将 `augmentHistoryWithKB` 中的 `maxKBChars` 限制从 1000 增加到 3000。
