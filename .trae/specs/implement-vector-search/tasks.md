# 向量搜索功能实现 - 实施计划

## [x] 任务1：在KnowledgeBaseChunk表中添加向量字段
- **优先级**：P0
- **依赖**：无
- **描述**：
  - 在KnowledgeBaseChunk结构体中添加Vector字段，类型为[]byte
  - 确保数据库迁移能够正确处理这个字段
- **验收标准**：AC-1
- **测试要求**：
  - `programmatic` TR-1.1：数据库迁移后，KnowledgeBaseChunk表应包含vector字段
  - `programmatic` TR-1.2：能够成功存储和读取向量数据
- **备注**：使用BLOB类型存储向量数据

## [x] 任务2：实现文本到向量的转换功能
- **优先级**：P0
- **依赖**：任务1
- **描述**：
  - 集成Embedding模型
  - 实现textToVector函数，将文本转换为向量
  - 在processFile函数中添加向量生成逻辑
- **验收标准**：AC-2
- **测试要求**：
  - `programmatic` TR-2.1：textToVector函数应返回非空向量
  - `programmatic` TR-2.2：相同文本应返回相同向量
- **备注**：需要选择合适的Embedding模型

## [x] 任务3：实现向量相似度计算功能
- **优先级**：P0
- **依赖**：任务1
- **描述**：
  - 实现cosineSimilarity函数，计算两个向量的余弦相似度
  - 确保相似度值在0-1之间
- **验收标准**：AC-3
- **测试要求**：
  - `programmatic` TR-3.1：相似向量应返回接近1的值
  - `programmatic` TR-3.2：不相似向量应返回接近0的值
- **备注**：余弦相似度计算公式：cosine = (A·B) / (||A|| * ||B||)

## [x] 任务4：修改SearchKBChunks函数，使用向量相似度进行搜索
- **优先级**：P0
- **依赖**：任务2, 任务3
- **描述**：
  - 修改SearchKBChunks函数，使用向量相似度进行搜索
  - 首先将查询转换为向量
  - 计算查询向量与所有存储向量的相似度
  - 按相似度排序返回结果
- **验收标准**：AC-4
- **测试要求**：
  - `programmatic` TR-4.1：搜索应返回语义相关的结果
  - `human-judgment` TR-4.2：搜索结果应比传统文本匹配更准确
- **备注**：使用Brute Force方法，遍历所有向量计算相似度

## [x] 任务5：优化Prompt结构
- **优先级**：P1
- **依赖**：无
- **描述**：
  - 修改buildMessagesWithSystemPrompt函数
  - 优化Prompt结构，明确要求模型只根据提供的上下文回答
  - 确保Prompt格式清晰，包含上下文和问题
- **验收标准**：AC-5
- **测试要求**：
  - `human-judgment` TR-5.1：Prompt应明确要求模型只根据上下文回答
  - `human-judgment` TR-5.2：模型回答应基于提供的上下文，而不是外部知识
- **备注**：使用用户提供的Prompt结构示例

## [x] 任务6：测试和优化
- **优先级**：P1
- **依赖**：任务1-5
- **描述**：
  - 测试向量搜索功能的准确性和性能
  - 优化向量计算和存储
  - 确保系统在不同规模的知识库下都能正常工作
- **验收标准**：AC-4, AC-5
- **测试要求**：
  - `programmatic` TR-6.1：系统应能处理不同规模的知识库
  - `human-judgment` TR-6.2：搜索结果应准确且相关
- **备注**：对于大规模知识库，可能需要考虑性能优化