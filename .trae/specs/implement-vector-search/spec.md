# 向量搜索功能实现 - 产品需求文档

## 概述
- **摘要**：实现基于向量的知识库搜索功能，包括向量存储、相似度计算和语义搜索，同时优化Prompt结构以确保模型只根据提供的上下文回答问题。
- **目的**：提升知识库搜索的准确性和相关性，实现语义级别的搜索能力，为用户提供更精准的回答。
- **目标用户**：使用本地知识库助手的用户。

## 目标
- 实现向量存储和相似度计算功能
- 集成Embedding模型用于语义搜索
- 优化Prompt结构，确保模型只根据上下文回答
- 保持与现有系统的兼容性

## 非目标（范围外）
- 不实现复杂的向量索引结构（如HNSW），使用Brute Force方法
- 不修改对话模型的核心实现

## 背景与上下文
- 现有系统使用简单的文本匹配进行知识库搜索，准确性有限
- 代码中已有注释表明未来计划增加向量字段
- 用户希望实现语义级别的搜索能力

## 功能需求
- **FR-1**：在KnowledgeBaseChunk表中添加向量字段，用于存储文本的向量表示
- **FR-2**：实现文本到向量的转换功能，使用Embedding模型
- **FR-3**：实现向量相似度计算功能，使用余弦相似度
- **FR-4**：修改SearchKBChunks函数，使用向量相似度进行搜索
- **FR-5**：优化Prompt结构，确保模型只根据提供的上下文回答问题

## 非功能需求
- **NFR-1**：搜索性能应保持在可接受范围内（对于中小型知识库）
- **NFR-2**：向量存储应高效利用数据库空间
- **NFR-3**：实现应与现有系统无缝集成

## 约束
- **技术**：使用SQLite数据库，GORM ORM框架
- **依赖**：需要引入Embedding模型相关库
- **性能**：由于使用Brute Force方法，大规模知识库的搜索性能可能受限

## 假设
- 系统能够访问Embedding模型
- 用户的知识库规模适中，Brute Force方法可以满足性能需求

## 验收标准

### AC-1：向量字段添加
- **给定**：数据库结构已存在
- **当**：添加向量字段后
- **则**：KnowledgeBaseChunk表应包含向量字段，类型为BLOB
- **验证**：`programmatic`

### AC-2：文本到向量转换
- **给定**：文本内容
- **当**：调用向量转换函数时
- **则**：应返回对应的向量表示
- **验证**：`programmatic`

### AC-3：向量相似度计算
- **给定**：两个向量
- **当**：计算相似度时
- **则**：应返回0-1之间的相似度值
- **验证**：`programmatic`

### AC-4：语义搜索功能
- **给定**：用户查询
- **当**：执行搜索时
- **则**：应返回语义相关的结果，而不仅仅是关键词匹配
- **验证**：`human-judgment`

### AC-5：Prompt结构优化
- **给定**：用户问题和检索到的上下文
- **当**：生成Prompt时
- **则**：Prompt应明确要求模型只根据提供的上下文回答
- **验证**：`human-judgment`

## 开放问题
- [ ] 选择哪个Embedding模型？
- [ ] 向量维度如何确定？
- [ ] 如何处理向量计算的性能问题？